variables:
  DJANGO_SETTINGS_MODULE: "project.settings"
  ACTIVITYPUB_TOOLKIT_DATABASE_PASSWORD: "activitypub_toolkit_ci"

stages:
  - build_docs
  - publish_docs
  - test
  - build
  - release

build_site:
  image: python:3.12
  before_script:
    - pip install poetry
    - poetry install --only docs

  stage: build_docs
  script:
    - poetry run mkdocs build
  artifacts:
    paths:
      - site
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      changes:
        - docs/*
        - mkdocs.yml

pages:
  stage: publish_docs
  image: python:3.12
  script:
    - mv site public
  artifacts:
    paths:
      - public
  needs:
    - build_site   
  
test:
  stage: test
  image: python:3.12
  services:
    - postgres:latest

  variables:
    POSTGRES_DB: activitypub_toolkit
    POSTGRES_USER: activitypub_toolkit
    POSTGRES_PASSWORD: "$ACTIVITYPUB_TOOLKIT_DATABASE_PASSWORD"

  script:
    - export
    - pip install poetry
    - poetry install
    - poetry run pytest

build_python_package:
  image: python:3.12
  stage: build

  script:
    - python setup.py build sdist

  artifacts:
    paths:
      - dist/

publish_python_package:
  image: python:3.12
  stage: release

  variables:
    TWINE_USERNAME: $TWINE_USERNAME
    TWINE_PASSWORD: $TWINE_PASSWORD
    TWINE_REPOSITORY_URL: $TWINE_REPOSITORY_URL

  script:
    - pip install twine
    - twine upload dist/* --non-interactive

  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/'
